--- origsrc/glom-1.12.3/configure.ac	2009-11-02 03:33:38.000000000 -0600
+++ src/glom-1.12.3/configure.ac	2009-11-03 02:54:59.855051900 -0600
@@ -66,7 +66,9 @@ AM_GLIB_GNU_GETTEXT
 AC_DEFINE([GETTEXT_PACKAGE], [PACKAGE_TARNAME], [Define to the gettext package name.])
 
 AC_MSG_CHECKING([whether to enable Windows specific options])
-AS_CASE([$host_os], [mingw*], [glom_host_win32=yes], [glom_host_win32=no])
+AS_CASE([$host_os], [mingw*], [glom_host_win32=yes],
+                    [cygwin*], [glom_host_cygwin=yes],
+                    [glom_host_cygwin=no; glom_host_win32=no])
 AC_MSG_RESULT([$glom_host_win32])
 
 AS_IF([test "x$glom_host_win32" = xyes],
@@ -144,7 +146,7 @@ AC_ARG_ENABLE([maemo-launcher],
 # libgda >= 4.1.2 is also OK, but not 4.1.<2.
 REQUIRED_LIBGLOM_LIBS='gthread-2.0 giomm-2.4 libxml++-2.6 pygda-4.0 >= 2.25.3 pygobject-2.0 >= 2.6.0 libgdamm-4.0 >= 3.99.14 libgda-4.0 >= 4.0.4 libgda-postgres-4.0'
 
-AS_IF([test "x$glom_host_win32" != xyes],
+AS_IF([test "x$glom_host_win32" != xyes && test "x$glom_host_cygwin" != xyes],
       [REQUIRED_LIBGLOM_LIBS="$REQUIRED_LIBGLOM_LIBS libepc-1.0 >= 0.3.1 avahi-ui"])
 
 # Libraries used by Glom:
--- origsrc/glom-1.12.3/glom/application.cc	2009-11-02 03:23:25.000000000 -0600
+++ src/glom-1.12.3/glom/application.cc	2009-11-03 02:57:24.139703500 -0600
@@ -47,11 +47,11 @@
 #include <hildon-fmmm.h>
 #endif // GLOM_ENABLE_MAEMO
 
-#ifndef G_OS_WIN32
+#ifndef G_PLATFORM_WIN32
 #include <libepc/consumer.h>
 #include <libsoup/soup-status.h>
 #include <avahi-ui/avahi-ui.h>
-#endif // !G_OS_WIN32
+#endif // !G_PLATFORM_WIN32
 
 #include <gtk/gtkstock.h> /* For use with the avahi-ui dialog. */
 
@@ -98,7 +98,7 @@ App_Glom::App_Glom(BaseObjectType* cobje
   add_mime_type("application/x-glom"); //TODO: make this actually work - we need to register it properly.
   
 #ifndef GLOM_ENABLE_CLIENT_ONLY
-#ifndef G_OS_WIN32
+#ifndef G_PLATFORM_WIN32
   //Install UI hooks for this:
   ConnectionPool* connection_pool = ConnectionPool::get_instance();
   if(!connection_pool)
@@ -669,7 +669,7 @@ void App_Glom::ui_warning_load_failed(in
 }
 
 
-#ifndef G_OS_WIN32
+#ifndef G_PLATFORM_WIN32
 void App_Glom::open_browsed_document(const EpcServiceInfo* server, const Glib::ustring& service_name)
 {
   gsize length = 0;
@@ -796,7 +796,7 @@ void App_Glom::open_browsed_document(con
     }
   }
 }
-#endif // !G_OS_WIN32
+#endif // !G_PLATFORM_WIN32
 
 #ifndef GLOM_ENABLE_CLIENT_ONLY
 //Copied from bakery:
@@ -1358,7 +1358,7 @@ bool App_Glom::offer_new_or_existing()
       case Dialog_ExistingOrNew::OPEN_URI:
         open_document(dialog->get_uri());
         break;
-#ifndef G_OS_WIN32
+#ifndef G_PLATFORM_WIN32
       case Dialog_ExistingOrNew::OPEN_REMOTE:
         open_browsed_document(dialog->get_service_info(), dialog->get_service_name());
         break;
--- origsrc/glom-1.12.3/glom/application.h	2009-10-16 03:56:18.000000000 -0500
+++ src/glom-1.12.3/glom/application.h	2009-11-03 02:57:36.167324500 -0600
@@ -164,13 +164,13 @@ private:
   void on_connection_avahi_done();
 #endif // !GLOM_ENABLE_CLIENT_ONLY
 
-#ifndef G_OS_WIN32
+#ifndef G_PLATFORM_WIN32
   /** Offer a file chooser dialog, with a Browse Network button.
    * @param browsed This will be set to true if the user chose a networked glom instance to open.
    * @browsed_server This will be filled with the server details if browsed was set to true.
    */
   Glib::ustring ui_file_select_open_with_browse(bool& browsed, EpcServiceInfo*& browsed_server, Glib::ustring& browsed_service_name, const Glib::ustring& starting_folder_uri = Glib::ustring());
-#endif // !G_OS_WIN32
+#endif // !G_PLATFORM_WIN32
 
   virtual void document_history_add(const Glib::ustring& file_uri); //overridden.
 
@@ -178,9 +178,9 @@ private:
   
   void on_connection_close_progress();
 
-#ifndef G_OS_WIN32
+#ifndef G_PLATFORM_WIN32
   void open_browsed_document(const EpcServiceInfo* server, const Glib::ustring& service_name);
-#endif // !G_OS_WIN32
+#endif // !G_PLATFORM_WIN32
 
   static Glib::ustring get_file_uri_without_extension(const Glib::ustring& uri);
 
--- origsrc/glom-1.12.3/glom/dialog_existing_or_new.cc	2009-11-02 03:23:25.000000000 -0600
+++ src/glom-1.12.3/glom/dialog_existing_or_new.cc	2009-11-03 02:59:09.970288000 -0600
@@ -36,7 +36,8 @@
 
 #ifdef G_OS_WIN32
 # include <glib/gwin32.h>
-#else
+#endif
+#ifndef G_PLATFORM_WIN32
 # include <libepc/service-type.h>
 #endif
 
@@ -130,7 +131,7 @@ Dialog_ExistingOrNew::Dialog_ExistingOrN
   m_iter_existing_other = m_existing_model->append();
   (*m_iter_existing_other)[m_existing_columns.m_col_title] = _("Select File");
 
-#ifndef G_OS_WIN32
+#ifndef G_PLATFORM_WIN32
   m_iter_existing_network = m_existing_model->append();
   (*m_iter_existing_network)[m_existing_columns.m_col_title] = _("Local Network");
 #endif
@@ -172,7 +173,7 @@ Dialog_ExistingOrNew::Dialog_ExistingOrN
 
 
   // Browse local network
-#ifndef G_OS_WIN32
+#ifndef G_PLATFORM_WIN32
   gchar* service_type = epc_service_type_new(EPC_PROTOCOL_HTTPS, "glom");
   m_service_monitor = epc_service_monitor_new_for_types(0, service_type, (void*)0);
   g_signal_connect(m_service_monitor, "service-found", G_CALLBACK(on_service_found_static), this);
@@ -198,7 +199,7 @@ Dialog_ExistingOrNew::Dialog_ExistingOrN
   if(children.begin() == children.end())
     m_iter_existing_recent_dummy = create_dummy_item_existing(m_iter_existing_recent, _(RECENT_DUMMY_TEXT));
 
-#ifndef G_OS_WIN32
+#ifndef G_PLATFORM_WIN32
   // Will be removed when items are added:
   m_iter_existing_network_dummy = create_dummy_item_existing(m_iter_existing_network, _(NETWORK_DUMMY_TEXT));
 #endif
@@ -207,7 +208,7 @@ Dialog_ExistingOrNew::Dialog_ExistingOrN
   // Expand recently used files and the networked files,
   // because the contents help to explain what this is: 
   m_existing_view->expand_row(m_existing_model->get_path(m_iter_existing_recent), false);
-#ifndef G_OS_WIN32
+#ifndef G_PLATFORM_WIN32
   m_existing_view->expand_row(m_existing_model->get_path(m_iter_existing_network), false);
 #endif
 
@@ -286,7 +287,7 @@ bool Dialog_ExistingOrNew::list_examples
 
 Dialog_ExistingOrNew::~Dialog_ExistingOrNew()
 {
-#ifndef G_OS_WIN32
+#ifndef G_PLATFORM_WIN32
   if(m_service_monitor)
   {
     g_object_unref(m_service_monitor);
@@ -307,7 +308,7 @@ Dialog_ExistingOrNew::~Dialog_ExistingOr
 bool Dialog_ExistingOrNew::on_existing_select_func(const Glib::RefPtr<Gtk::TreeModel>& model, const Gtk::TreeModel::Path& path, bool /* path_currently_selected */)
 {
   Gtk::TreeModel::iterator iter = model->get_iter(path);
-#ifndef G_OS_WIN32
+#ifndef G_PLATFORM_WIN32
   if(iter == m_iter_existing_network)
     return false; /* Do not allow parent nodes to be selected. */
 #endif
@@ -338,7 +339,7 @@ Dialog_ExistingOrNew::Action Dialog_Exis
     iter = m_existing_view->get_selection()->get_selected();
     if(m_existing_model->is_ancestor(m_iter_existing_recent, iter))
       return OPEN_URI;
-#ifndef G_OS_WIN32
+#ifndef G_PLATFORM_WIN32
     if(m_existing_model->is_ancestor(m_iter_existing_network, iter))
       return OPEN_REMOTE;
 #endif
@@ -406,7 +407,7 @@ Glib::ustring Dialog_ExistingOrNew::get_
   return Glib::ustring();
 }
 
-#ifndef G_OS_WIN32
+#ifndef G_PLATFORM_WIN32
 EpcServiceInfo* Dialog_ExistingOrNew::get_service_info() const
 {
   Gtk::TreeModel::iterator iter;
@@ -471,7 +472,7 @@ void Dialog_ExistingOrNew::existing_icon
 
   if(iter == m_iter_existing_recent)
     pixbuf_renderer->property_stock_id() = Gtk::StockID(Gtk::Stock::INDEX); // TODO: More meaningful icon?
-#ifndef G_OS_WIN32
+#ifndef G_PLATFORM_WIN32
   else if(iter == m_iter_existing_network)
     pixbuf_renderer->property_stock_id() = Gtk::StockID(Gtk::Stock::NETWORK);
 #endif
@@ -479,7 +480,7 @@ void Dialog_ExistingOrNew::existing_icon
     pixbuf_renderer->property_stock_id() = Gtk::StockID(Gtk::Stock::OPEN);
   else if(m_iter_existing_recent_dummy.get() && iter == *m_iter_existing_recent_dummy)
     pixbuf_renderer->property_stock_id() = Gtk::StockID(Gtk::Stock::DIALOG_ERROR); // TODO: Use Stock::STOP instead?
-#ifndef G_OS_WIN32
+#ifndef G_PLATFORM_WIN32
   else if(m_iter_existing_network_dummy.get() && iter == *m_iter_existing_network_dummy)
     pixbuf_renderer->property_stock_id() = Gtk::StockID(Gtk::Stock::DIALOG_ERROR); // TODO: Use Stock::STOP instead?
 #endif
@@ -492,7 +493,7 @@ void Dialog_ExistingOrNew::existing_icon
 
   if(iter == m_iter_existing_recent)
     pixbuf_renderer->set_property("stock-id", Gtk::StockID(Gtk::Stock::INDEX));
-#ifndef G_OS_WIN32
+#ifndef G_PLATFORM_WIN32
   else if(iter == m_iter_existing_network)
     pixbuf_renderer->set_property("stock-id", Gtk::StockID(Gtk::Stock::NETWORK));
 #endif
@@ -500,7 +501,7 @@ void Dialog_ExistingOrNew::existing_icon
     pixbuf_renderer->set_property("stock-id", Gtk::StockID(Gtk::Stock::OPEN));
   else if(m_iter_existing_recent_dummy.get() && iter == *m_iter_existing_recent_dummy)
     pixbuf_renderer->set_property("stock-id", Gtk::StockID(Gtk::Stock::DIALOG_ERROR)); // TODO: Use Stock::STOP instead?
-#ifndef G_OS_WIN32
+#ifndef G_PLATFORM_WIN32
   else if(m_iter_existing_network_dummy.get() && iter == *m_iter_existing_network_dummy)
     pixbuf_renderer->set_property("stock-id", Gtk::StockID(Gtk::Stock::DIALOG_ERROR)); // TODO: Use Stock::STOP instead?
 #endif
@@ -514,7 +515,7 @@ void Dialog_ExistingOrNew::existing_icon
       //pixbuf_renderer->property_pixbuf() = (*info)->get_icon(Gtk::ICON_SIZE_BUTTON);
       pixbuf_renderer->set_property("icon-name", Glib::ustring("glom"));
     }
-#ifndef G_OS_WIN32
+#ifndef G_PLATFORM_WIN32
     else if(m_existing_model->is_ancestor(m_iter_existing_network, iter))
     {
       //pixbuf_renderer->property_stock_id() = Gtk::Stock::CONNECT.id;
@@ -547,7 +548,7 @@ void Dialog_ExistingOrNew::existing_titl
   text_renderer->property_foreground_set() = false;
   
   // Use grey if parent item has no children:
-#ifndef G_OS_WIN32
+#ifndef G_PLATFORM_WIN32
   if( (iter == m_iter_existing_network && m_iter_existing_network_dummy.get()) ||
       (iter == m_iter_existing_recent && m_iter_existing_recent_dummy.get()))
 #else
@@ -562,7 +563,7 @@ void Dialog_ExistingOrNew::existing_titl
   // Default: Use default color
   text_renderer->set_property("foreground-set", false);
   // Use grey if parent item has no children
-#ifndef G_OS_WIN32
+#ifndef G_PLATFORM_WIN32
   if( (iter == m_iter_existing_network && m_iter_existing_network_dummy.get()) ||
       (iter == m_iter_existing_recent && m_iter_existing_recent_dummy.get()))
 #else
@@ -704,12 +705,12 @@ void Dialog_ExistingOrNew::update_ui_sen
     {
       Gtk::TreeModel::iterator sel = m_existing_view->get_selection()->get_selected();
       sensitivity = (sel != m_iter_existing_recent);
-#ifndef G_OS_WIN32
+#ifndef G_PLATFORM_WIN32
       sensitivity = sensitivity && (sel != m_iter_existing_network);
 #endif
 
       sensitivity = sensitivity && (!m_iter_existing_recent_dummy.get() || sel != *m_iter_existing_recent_dummy);
-#ifndef G_OS_WIN32
+#ifndef G_PLATFORM_WIN32
       sensitivity = sensitivity && (!m_iter_existing_network_dummy.get() || sel != *m_iter_existing_network_dummy);
 #endif
     }
@@ -861,7 +862,7 @@ void Dialog_ExistingOrNew::on_stream_rea
 }
 #endif /* !GLOM_ENABLE_CLIENT_ONLY */
 
-#ifndef G_OS_WIN32
+#ifndef G_PLATFORM_WIN32
 void Dialog_ExistingOrNew::on_service_found_static(EpcServiceMonitor* /* monitor */, gchar* name, EpcServiceInfo* info, gpointer user_data)
 {
   static_cast<Dialog_ExistingOrNew*>(user_data)->on_service_found(name, info);
@@ -913,7 +914,7 @@ void Dialog_ExistingOrNew::on_service_re
     }
   }
 }
-#endif // !G_OS_WIN32
+#endif // !G_PLATFORM_WIN32
 
 void Dialog_ExistingOrNew::on_existing_row_activated(const Gtk::TreeModel::Path& /* path */, Gtk::TreeViewColumn* /* column */)
 {
--- origsrc/glom-1.12.3/glom/dialog_existing_or_new.h	2009-09-28 05:51:21.000000000 -0500
+++ src/glom-1.12.3/glom/dialog_existing_or_new.h	2009-11-03 02:59:25.804315600 -0600
@@ -35,7 +35,7 @@
 #include <gtkmm/notebook.h>
 #include <gtkmm/builder.h>
 
-#ifndef G_OS_WIN32
+#ifndef G_PLATFORM_WIN32
 # include <libepc/service-monitor.h>
 #endif
 
@@ -59,7 +59,7 @@ public:
 
   Action get_action() const;
   Glib::ustring get_uri() const; // Only when get_action is NEW_FROM_TEMPLATE or OPEN_URI
-#ifndef G_OS_WIN32
+#ifndef G_PLATFORM_WIN32
   EpcServiceInfo* get_service_info() const; // Only when get_action is OPEN_REMOTE
   Glib::ustring get_service_name() const; // Only when get_action is OPEN_REMOTE
 #endif
@@ -98,7 +98,7 @@ private:
   void on_stream_read(const Glib::RefPtr<Gio::AsyncResult>& res);
 #endif /* !GLOM_ENABLE_CLIENT_ONLY */
     
-#ifndef G_OS_WIN32
+#ifndef G_PLATFORM_WIN32
   static void on_service_found_static(EpcServiceMonitor* monitor, gchar* name, EpcServiceInfo* info, gpointer user_data);
   static void on_service_removed_static(EpcServiceMonitor* monitor, gchar* name, gchar* type, gpointer user_data);
 
@@ -123,7 +123,7 @@ private:
       add(m_col_title);
       add(m_col_time);
 
-#ifndef G_OS_WIN32
+#ifndef G_PLATFORM_WIN32
       add(m_col_service_name);
       add(m_col_service_info);
 #endif
@@ -134,7 +134,7 @@ private:
     Gtk::TreeModelColumn<Glib::ustring> m_col_title;
     Gtk::TreeModelColumn<std::time_t> m_col_time; // Sort criteria
 
-#ifndef G_OS_WIN32
+#ifndef G_PLATFORM_WIN32
     // For service discovery:
     Gtk::TreeModelColumn<Glib::ustring> m_col_service_name;
     Gtk::TreeModelColumn<EpcServiceInfo*> m_col_service_info;
@@ -181,13 +181,13 @@ private:
 
   //Iterators to the parent nodes:
   Gtk::TreeModel::iterator m_iter_existing_recent;
-#ifndef G_OS_WIN32
+#ifndef G_PLATFORM_WIN32
   Gtk::TreeModel::iterator m_iter_existing_network;
 #endif
   Gtk::TreeModel::iterator m_iter_existing_other;
  
   // Dummy children to indicate that a parent item has no (real) children
-#ifndef G_OS_WIN32
+#ifndef G_PLATFORM_WIN32
   std::auto_ptr<Gtk::TreeModel::iterator> m_iter_existing_network_dummy;
 #endif
   std::auto_ptr<Gtk::TreeModel::iterator> m_iter_existing_recent_dummy;
@@ -203,7 +203,7 @@ private:
   std::auto_ptr<buffer> m_current_buffer;
 #endif /* !GLOM_ENABLE_CLIENT_ONLY */
     
-#ifndef G_OS_WIN32
+#ifndef G_PLATFORM_WIN32
   EpcServiceMonitor* m_service_monitor;
 #endif
 
--- origsrc/glom-1.12.3/glom/frame_glom.cc	2009-10-16 03:56:18.000000000 -0500
+++ src/glom-1.12.3/glom/frame_glom.cc	2009-11-03 11:19:17.078350600 -0600
@@ -1203,7 +1203,7 @@ void Frame_Glom::on_menu_Mode_Find()
     m_Notebook_Find.set_current_view(list_or_details);
   }
   
-  #ifdef GLOM_ENABLE_CLIENT_ONLY
+  #ifdef GLOM_ENABLE_MAEMO
   Gtk::Window* parent = get_app_window();
   g_assert(parent);
   if(parent)
--- origsrc/glom-1.12.3/glom/libglom/connectionpool.cc	2009-11-02 03:23:25.000000000 -0600
+++ src/glom-1.12.3/glom/libglom/connectionpool.cc	2009-11-03 11:22:51.324383700 -0600
@@ -28,14 +28,15 @@
 
 #ifdef G_OS_WIN32
 # include <windows.h>
-#else
+#endif
+#ifndef G_PLATFORM_WIN32
 # include <libepc/shell.h> //For epc_shell_set_progress_hooks().
 # include <libepc/publisher.h>
 #endif
 
 #include <signal.h> //To catch segfaults
 
-#ifndef G_OS_WIN32
+#ifndef G_PLATFORM_WIN32
 static EpcProtocol publish_protocol = EPC_PROTOCOL_HTTPS;
 #endif
 
@@ -308,7 +309,7 @@ sharedptr<SharedConnection> ConnectionPo
         if(!m_pFieldTypes)
           m_pFieldTypes = new FieldTypes(m_refGdaConnection);
           
-#ifndef G_OS_WIN32
+#ifndef G_PLATFORM_WIN32
         //Let other clients discover this server via avahi:
         //TODO: Only advertize if we are the first to open the document,
         //to avoid duplicates.
@@ -317,7 +318,7 @@ sharedptr<SharedConnection> ConnectionPo
         Document* document = get_document();
         if(document && document->get_network_shared())
           avahi_start_publishing(); //Stopped in the signal_finished handler.
-#endif // !G_OS_WIN32
+#endif // !G_PLATFORM_WIN32
 
 #ifdef GLIBMM_EXCEPTIONS_ENABLED
         return connect(); //Call this method recursively. This time m_refGdaConnection exists.
@@ -441,7 +442,7 @@ void ConnectionPool::on_sharedconnection
 
     m_refGdaConnection.reset();
 
-#ifndef G_OS_WIN32
+#ifndef G_PLATFORM_WIN32
     //TODO: this should only even be started if we are the first to open the .glom file:
     avahi_stop_publishing();
 #endif
@@ -495,6 +496,9 @@ bool ConnectionPool::handle_error_cerr_o
 // TODO: This is probably mingw specific
 static __p_sig_fn_t previous_sig_handler = SIG_DFL;
 #else
+#ifdef G_WITH_CYGWIN
+typedef _sig_func_ptr sighandler_t;
+#endif
 static sighandler_t previous_sig_handler = SIG_DFL; /* Arbitrary default */
 #endif
 
@@ -528,10 +532,10 @@ bool ConnectionPool::startup(const SlotP
   if(!m_backend->startup(slot_progress, network_shared))
     return false;
 
-#ifndef G_OS_WIN32
+#ifndef G_PLATFORM_WIN32
   //Let clients discover this server via avahi:
   //avahi_start_publishing();
-#endif // !G_OS_WIN32
+#endif // !G_PLATFORM_WIN32
 
   //If we crash while running (unlikely, hopefully), then try to cleanup.
   //Comment this out if you want to see the backtrace in a debugger.
@@ -558,10 +562,10 @@ void ConnectionPool::cleanup(const SlotP
   invalidate_connection();
 
 
-#ifndef G_OS_WIN32
+#ifndef G_PLATFORM_WIN32
   /* Stop advertising the self-hosting database server via avahi: */
   //avahi_stop_publishing();
-#endif // !G_OS_WIN32
+#endif // !G_PLATFORM_WIN32
 
   //We don't need the segfault handler anymore:
   signal(SIGSEGV, previous_sig_handler);
@@ -727,7 +731,7 @@ Document* ConnectionPool::get_document()
   return m_slot_get_document();
 }
 
-#ifndef G_OS_WIN32
+#ifndef G_PLATFORM_WIN32
 //static
 EpcContents* ConnectionPool::on_publisher_document_requested(EpcPublisher* /* publisher */, const gchar* /* key */, gpointer user_data)
 {
@@ -883,13 +887,13 @@ void ConnectionPool::avahi_stop_publishi
   std::cout << "debug: ConnectionPool::avahi_stop_publishing" << std::endl;
 #endif
 
-#ifndef G_OS_WIN32
+#ifndef G_PLATFORM_WIN32
   epc_publisher_quit(m_epc_publisher);
-#endif // !G_OS_WIN32
+#endif // !G_PLATFORM_WIN32
   g_object_unref(m_epc_publisher);
   m_epc_publisher = 0;
 }
-#endif // !G_OS_WIN32
+#endif // !G_PLATFORM_WIN32
 
 void ConnectionPool::set_get_document_func(const SlotGetDocument& slot)
 {
--- origsrc/glom-1.12.3/glom/libglom/connectionpool.h	2009-11-02 03:23:25.000000000 -0600
+++ src/glom-1.12.3/glom/libglom/connectionpool.h	2009-11-03 02:56:33.829615800 -0600
@@ -104,7 +104,7 @@ public:
   
   typedef sigc::slot<void> type_void_slot;
   
-#ifndef G_OS_WIN32
+#ifndef G_PLATFORM_WIN32
   /** Set callbacks that will be called to show UI while starting to advertise 
    * on the network via Avahi.
    *
@@ -241,14 +241,14 @@ public:
   typedef sigc::slot<Document*> SlotGetDocument; 
   void set_get_document_func(const SlotGetDocument& slot);
 
-#ifndef G_OS_WIN32
+#ifndef G_PLATFORM_WIN32
   static EpcContents* on_publisher_document_requested (EpcPublisher* publisher, const gchar* key, gpointer user_data);
   static gboolean on_publisher_document_authentication(EpcAuthContext* context, const gchar* user_name, gpointer user_data);
 
   static void on_epc_progress_begin(const gchar *title, gpointer user_data);
   static void on_epc_progress_update(gdouble progress, const gchar* message, gpointer user_data);
   static void on_epc_progress_end(gpointer user_data);
-#endif // !G_OS_WIN32
+#endif // !G_PLATFORM_WIN32
 
   //Show the gda error in a dialog.
   static bool handle_error_cerr_only();
@@ -268,12 +268,12 @@ private:
 
   Document* get_document();
 
-#ifndef G_OS_WIN32
+#ifndef G_PLATFORM_WIN32
   /** Advertize self-hosting via avahi:
    */
   void avahi_start_publishing();
   void avahi_stop_publishing();
-#endif // !G_OS_WIN32
+#endif // !G_PLATFORM_WIN32
 
 private:
 
--- origsrc/glom-1.12.3/glom/main.cc	2009-11-02 03:23:25.000000000 -0600
+++ src/glom-1.12.3/glom/main.cc	2009-11-03 03:02:59.727488600 -0600
@@ -361,18 +361,19 @@ bool check_pygda_is_available_with_warni
 
 } //namespace Glom
 
-#ifndef G_OS_WIN32
+#ifndef G_PLATFORM_WIN32
 extern "C" void __libc_freeres(void);
 #endif
 
 int 
 main(int argc, char* argv[])
 {
-#ifndef G_OS_WIN32
+#ifndef G_PLATFORM_WIN32
   //Force some cleanup at exit,
   //to help valgrind to detect memory leaks:
   atexit(__libc_freeres);
-#else
+#endif
+#ifdef G_OS_WIN32
   WSADATA data;
   int errcode = WSAStartup(MAKEWORD(2, 0), &data);
   if(errcode != 0)
--- origsrc/glom-1.12.3/tests/test_python_module.cc	2009-09-18 02:34:35.000000000 -0500
+++ src/glom-1.12.3/tests/test_python_module.cc	2009-11-03 03:03:41.769561900 -0600
@@ -5,7 +5,7 @@
 #include "config.h"
 #include "glom/python_embed/glom_python.h"
 
-#ifndef G_OS_WIN32
+#ifndef G_PLATFORM_WIN32
 extern "C" void __libc_freeres(void);
 #endif
 
@@ -41,7 +41,7 @@ bool gda_python_module_is_available()
 
 int main ()
 {
-#ifndef G_OS_WIN32
+#ifndef G_PLATFORM_WIN32
   atexit(__libc_freeres);
 #endif
   Glom::libglom_init();  // Calls PyInitialize()
